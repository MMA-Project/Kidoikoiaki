name: Deploy to Azure

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'backend/**'
      - 'front/**'
      - 'Dockerfile'
      - 'Dockerfile.frontend'
      - 'bicep/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  REGISTRY: kdkacr.azurecr.io
  BACKEND_IMAGE: kidoikoiaki-backend
  FRONTEND_IMAGE: kidoikoiaki-frontend

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Azure login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to Azure Container Registry
        run: |
          az acr login --name $(echo ${{ env.REGISTRY }} | cut -d. -f1)

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:latest
            ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:buildcache,mode=max

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.frontend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:latest
            ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:buildcache,mode=max

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    strategy:
      matrix:
        environment: [dev]
    environment: ${{ matrix.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set environment variables
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "ENVIRONMENT=prod" >> $GITHUB_ENV
            echo "RESOURCE_GROUP=kdk-prod-rg" >> $GITHUB_ENV
          elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "ENVIRONMENT=staging" >> $GITHUB_ENV
            echo "RESOURCE_GROUP=kdk-staging-rg" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
            echo "RESOURCE_GROUP=kdk-dev-rg" >> $GITHUB_ENV
          fi

      - name: Create resource group
        run: |
          az group create \
            --name ${{ env.RESOURCE_GROUP }} \
            --location westeurope \
            || echo "Resource group already exists"

      - name: Validate Bicep template
        run: |
          az bicep build-params \
            --file bicep/parameters.${{ env.ENVIRONMENT }}.biceparam
          az deployment group validate \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --template-file bicep/main.bicep \
            --parameters @bicep/parameters.${{ env.ENVIRONMENT }}.biceparam

      - name: Deploy infrastructure
        run: |
          az deployment group create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --template-file bicep/main.bicep \
            --parameters @bicep/parameters.${{ env.ENVIRONMENT }}.biceparam \
            --parameters backendImageUri=${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}

      - name: Get deployment outputs
        id: deployment
        run: |
          outputs=$(az deployment group show \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name main \
            --query "properties.outputs" -o json)
          echo "outputs=$outputs" >> $GITHUB_OUTPUT

      - name: Deploy to backend App Service
        uses: azure/webapps-deploy@v2
        with:
          app-name: kdk-${{ env.ENVIRONMENT }}-backend
          images: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}

      - name: Notify deployment success
        if: success()
        run: |
          echo "✅ Deployment to ${{ env.ENVIRONMENT }} succeeded!"
          echo "Backend: $(echo '${{ steps.deployment.outputs.outputs }}' | jq -r '.backendAppUrl.value')"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "❌ Deployment to ${{ env.ENVIRONMENT }} failed!"
          exit 1
